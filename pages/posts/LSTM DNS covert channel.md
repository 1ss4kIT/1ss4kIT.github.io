---
layout: post
title: 基于LSTM模型的DNS隐蔽信道检测方法
tags: []
categories:
  - paper阅读笔记
author: 1ss4k
date: 2021-02-03 12:05:00
---
本文发表于Computers & Security，作者来自于北航、软件所、应急响应技术中心，发表时间2020年10月。



# 一、背景及目的

1、DNS(域名系统)作用是将域名转为IP地址。防火墙一般不过滤DNS，攻击者通常使用DNS来构建隐蔽通道。

2、构建DNS隐蔽信道的方法大致分为两类：基于IP连接的 和 基于查询域名的。

3、文中解释了DNS隐蔽信道的实现过程。

4、DNS隐蔽信道可以分为合法的和恶意的。恶意的分为两类：DNS渗出和DNS隧道。恶意的隐蔽信道可以实现窃取用户信息以及对主机的控制。

5、FQDN是完全限定域名。它适用于检测隐蔽信道，并且能够检查出上述两种类型的。

假阳性的情况包括：CDNs(内容交付网络) 和 DDOS攻击，以及一些合法的隐蔽信道的流量。本文提出了：组合 和 白名单的方法



# 二、前人工作

1、基于单包的检测方法

* 检测单个DNS包 或 请求/响应对的内容。

* 基于FQDN的检测方法认为，在隐蔽信道中，客户端发送的数据 通常都包含在FQDNs的子域部分中。

[15]将每个FQDN作为一个确定单位，并根据双字符频率 计算每个FQDN的得分。然后使用阈值进行判定。

* 基于RR数据的方法 检测DNS响应数据包resource record。

[18]分别检测DNS exfiltration 和 DNS tunneling。首先将标记数据进行聚类，然后将新样本分类到这些已知聚类中。

* 有学者不仅仅使用payload作为检测对象。

[19]使用了DNS的比特序列，和CNN模型。

[20]使用请求响应包的结合，提取几个特征，加上SVM和kmeans。

[21]将请求和响应包对用作数据对象。他们提取了59个维度特征



2、基于包集合的检测方法

将数据包分成set，提取每个set的特征。

* 时间片划分

[27]和[28]认为，普通的DNS流量之间有很多共通的信息。他们算了连续r个集合的特征之间的共通信息。

* FQDNs域划分

这种划分方法会把一种服务划分到一个set里面。

* 请求、响应的IP 

[22]证明了少量的数据，比如100个FQDN，可以有效地分离正常和隧道通信。

* 网络流

DNS流是由相同属性的数据包的集合。



# 三、本文方法

1、前置知识

​	对于序列数据的学习问题，RNN模型可以对以前的状态进行记忆并应用于输出计算，可以充分利用序列数据的信息。

​	LSTM模型是基于RNN的，对文本具有较好的分类性能。并且LSTM可以接受流数据，因此只需要对数据进行简单的预处理，就可以实现端到端的实时检测。特征方面：提取特征比较不容易，本文用LSTM，不依赖于特征。将DNS包的FQDNs作为输入的payload，使用LSTM完成端到端的实时检测。

​	正常的FQDN可以看做是语义序列，而隐蔽信道的FQDNs可以看做是随机序列。只有FQDN的子域部分可以用来编码隐蔽数据，因此我们只检测FQDN的子域部分。此外，不同的工具产生的分隔符'.'的位置是不同的，所以要移除点。此外，用白名单的过滤方法，去除哪些假阳性的数据。



2、模型结构

模型包括如下三部分：数据预处理、模型测定 和分组滤波。

![upload successful](/images/pasted-227.png)

3、预处理

​	将不可见字符进行16进制编码。

预处理大致的步骤如下：

1) 从FQDNs中移除 2LD.TLDs。

2) 将所有大写字符转换为小写字符

3)移除FQNDs中的分隔符'.'

4) 统一字符串的长度。

​	将字符串转为 word vectors，并且将序列长度固定为<128。过长的只保留前128，过短的填充。



4、模型测定

本文的LSTM模型包含一个隐藏层。

因为fqdn通常很短，所以前128个字符在很大程度上可以保证它包含原始信息。因此，我们的LSTM模型的隐藏状态数被设置为128。状态数对应于网络的长度，层数对应于网络的深度。

每个LSTM接受当前输入 及其上一个消息中的状态，并将计算结果传播到下一个消息单元。



5、分组滤波

​	[31]指出，最好的方法是使用DNS zones，这样一个隐蔽信道的所有流量会被分到一个单元中去。但是不容易找到DNS zones。

​	本文分组方法是根据 2LD.TLD。分组算法如下

![upload successful](/images/pasted-228.png)


![upload successful](/images/pasted-229.png)


1）移除重复查询的FQDNs

​	从人性的角度考虑，为了隐蔽性，通常不会将一个FQDNs发送多次。因此我们认为，重复的FQDNs 应该都不是隐蔽信道发送的。

​	此处去除重复次数 >ts1的FQDNs包。

2）删除包含少量FQDNs的组

​	阈值时ts2，包含的FQDNs数量<ts2的，就删除。本文实验设定的参数为5。

3）删除FQDNs被多个IP查询的组

4）使用白名单滤波

​	将合法的创建一个白名单。



# 四、实验结果

1、数据集

​	数据集：使用了来自网上的数据包，以及DNS隐蔽信道工具生成的数据包。其中包括泛化的测试数据集，以及模型训练产生的FQDN和DNS数据包。

​	构建了两个数据集：FQDNs的数据集和DNS数据包的数据集。

1）FQDNs数据集

使用的良性数据集 来自于真实的数据，并且自己提前删除了可疑的数据。最后的良性数据集包含3000,000 FQDNs。

关于泛化数据集：

{第一次泛化测试集中的FQDNs 与训练集中的FQDNs相同。第二第三组中的FQDNs 是随机的，但是较短，因此较难检测。第四个包含真实的数据。

对于一些合法的隐蔽信道，我们在训练阶段还是视为非法的，然后最后再用白名单过滤掉。}

2）DNS包

收集了真实世界的DNS数据包，进行评价。


2、衡量指标

对FQDNs和DNS使用不同的衡量指标。

对于FQDNs，使用Accuracy、precision、recall、F- Measure。

对于DNS，使用recall 和 假阳率。



3、实验设置

总共进行三组实验。

1）实验1 --- 检测模型的有效性

比较了LSTM和CNN、以及文献[16]的效果。数据集是FQDNs。

CNN：将预处理的FQDNs转为图像，并且缩放到128维。CNN模型包含3个卷积层、2个max-pooling 层，一个softmax层。

对于[16]，类比文中到数据集，自己创建了一个数据集，用来训练孤立森林模型。

实验结果如下：

recall越高越好， 
![upload successful](/images/pasted-230.png)

2）实验2 --- 预处理

是否小写、是否去除分隔符 对实验结果的影响。在FQDNs进行测试。实验结果如下：
![upload successful](/images/pasted-231.png)

3）实验3 --- 分组滤波的效果

在DNS包上进行测试，并且白名单过滤法只包含5个2LD.TLDs：baidu.com/cloudfront.net/gstatic.com/rackcdn.com/office.com。



4、真实流量检测的结果

检测到了使用onlinecc.com的隐蔽信道，以及两个可疑的信道。并且也发现了一些合法的隐蔽信道。



# 五、未来工作及收获

(1)优化模型结构和损失函数，来提升模型的泛化能力。

(2)使用active learning 去发现实际网络中的良性或恶意的FQDNs，去补充我们的数据集。



收获

(1) LSTM不依赖于特征，尝试一下自己能否使用？预处理过程也参考本文的。
(2) 良性URL是否寻在语义序列，恶意的更偏向于随机的？
(3) CNN更加适合于处理图像，所以可以把我们的数据转成图像再处理